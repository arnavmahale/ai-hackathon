name: Start Agent Analysis
on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    env:
      GUARDIANS_API_URL: ${{ secrets.GUARDIANS_API_URL }}
      GUARDIANS_API_TOKEN: ${{ secrets.GUARDIANS_API_TOKEN }}

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Collect PR identifiers
      - name: Collect PR metadata
        id: meta
        shell: bash
        run: |
          echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "pr_number=${{ github.event.number }}" >> $GITHUB_OUTPUT
          echo "base_branch=${{ github.base_ref }}" >> $GITHUB_OUTPUT
          echo "head_branch=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          echo "base_sha=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
          echo "head_sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          echo "diff_url=${{ github.event.pull_request.diff_url }}" >> $GITHUB_OUTPUT
          echo "patch_url=${{ github.event.pull_request.patch_url }}" >> $GITHUB_OUTPUT

      # List changed files
      - name: Get list of changed files
        id: diff
        shell: bash
        run: |
          base="${{ steps.meta.outputs.base_sha }}"
          head="${{ steps.meta.outputs.head_sha }}"
          git diff --name-only "$base" "$head" > changed_files.txt
          files=$(tr '\n' ',' < changed_files.txt | sed 's/,$//')
          echo "files=$files" >> "$GITHUB_OUTPUT"

      # Build payload folder on the runner
      - name: Build payload folder
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          PR="${{ steps.meta.outputs.pr_number }}"
          HEAD="${{ steps.meta.outputs.head_sha }}"
          OUTDIR="agent-payload/pr-${PR}-${HEAD}"
          mkdir -p "$OUTDIR"

          # Raw diff only (removed pr.patch)
          curl -sSL -H "Authorization: Bearer $GH_TOKEN" \
            "${{ steps.meta.outputs.diff_url }}" \
            -o "$OUTDIR/pr.diff"

          # Per-file patches JSON
          curl -sSL -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${{ steps.meta.outputs.repo }}/pulls/${PR}/files?per_page=300" \
            -o "$OUTDIR/files.json"

          # Author info
          AUTHOR="${{ github.event.pull_request.user.login }}"

          # Minimal metadata JSON (now includes 'author')
          jq -n \
            --arg repo        "${{ steps.meta.outputs.repo }}" \
            --arg pr_number   "${PR}" \
            --arg base_branch "${{ steps.meta.outputs.base_branch }}" \
            --arg head_branch "${{ steps.meta.outputs.head_branch }}" \
            --arg base_sha    "${{ steps.meta.outputs.base_sha }}" \
            --arg head_sha    "${HEAD}" \
            --arg changed     "${{ steps.diff.outputs.files }}" \
            --arg diff_url    "${{ steps.meta.outputs.diff_url }}" \
            --arg author      "${AUTHOR}" \
            '{repo:$repo, pr_number:$pr_number, author:$author,
              base_branch:$base_branch, head_branch:$head_branch,
              base_sha:$base_sha, head_sha:$head_sha,
              changed_files_csv:$changed, diff_url:$diff_url}' \
            > "$OUTDIR/meta.json"

          # Save current contents of changed files at head
          mkdir -p "$OUTDIR/files"
          while IFS= read -r f; do
            if [ -f "$f" ]; then
              mkdir -p "$OUTDIR/files/$(dirname "$f")"
              cp --parents "$f" "$OUTDIR" 2>/dev/null || true
            fi
          done < changed_files.txt

      - name: Notify Guardians backend
        if: env.GUARDIANS_API_URL != ''
        shell: bash
        env:
          API_URL: ${{ env.GUARDIANS_API_URL }}
          API_TOKEN: ${{ env.GUARDIANS_API_TOKEN }}
        run: |
          CHANGED_JSON=$(jq -R -s 'split("\n") | map(select(length>0))' changed_files.txt)
          PAYLOAD=$(jq -n \
            --arg repo "${{ steps.meta.outputs.repo }}" \
            --argjson pr_number ${{ steps.meta.outputs.pr_number }} \
            --arg title "${{ github.event.pull_request.title }}" \
            --arg author "${{ github.event.pull_request.user.login }}" \
            --arg baseBranch "${{ steps.meta.outputs.base_branch }}" \
            --arg headBranch "${{ steps.meta.outputs.head_branch }}" \
            --argjson filesChanged ${{ github.event.pull_request.changed_files }} \
            --argjson linesAdded ${{ github.event.pull_request.additions }} \
            --argjson linesRemoved ${{ github.event.pull_request.deletions }} \
            --argjson changedFiles "$CHANGED_JSON" \
            '{
              repo: $repo,
              pr_number: $pr_number,
              title: $title,
              author: $author,
              baseBranch: $baseBranch,
              headBranch: $headBranch,
              filesChanged: $filesChanged,
              linesAdded: $linesAdded,
              linesRemoved: $linesRemoved,
              changedFiles: $changedFiles
            }')

          if [ -z "$API_URL" ]; then
            echo "API_URL not set, skipping notification."
            exit 0
          fi

          if [ -n "$API_TOKEN" ]; then
            AUTH_HEADER=(-H "Authorization: Bearer $API_TOKEN")
          else
            AUTH_HEADER=()
          fi

          curl -sS -X POST "$API_URL/pull-requests" \
            -H "Content-Type: application/json" \
            "${AUTH_HEADER[@]}" \
            -d "$PAYLOAD"

      # Upload as an artifact
      - name: Upload PR payload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ steps.meta.outputs.pr_number }}-${{ steps.meta.outputs.head_sha }}
          path: agent-payload
          retention-days: 30
